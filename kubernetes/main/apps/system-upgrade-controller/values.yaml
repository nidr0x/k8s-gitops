controllers:
  system-upgrade-controller:
    strategy: RollingUpdate
    replicas: 1
    pod:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
      tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

    containers:
      app:
        image:
          repository: docker.io/rancher/system-upgrade-controller
          tag: v0.18.0
        env:
          SYSTEM_UPGRADE_CONTROLLER_LEADER_ELECT: true
          SYSTEM_UPGRADE_CONTROLLER_NAME: system-upgrade-controller
          SYSTEM_UPGRADE_CONTROLLER_NAMESPACE:
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          SYSTEM_UPGRADE_CONTROLLER_NODE_NAME:
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          SYSTEM_UPGRADE_JOB_PRIVILEGED: false
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault

  rawResources:
    talosServiceAccount:
      apiVersion: talos.dev/v1alpha1
      kind: ServiceAccount
      spec:
        roles:
          - os:admin

  rbac:
    bindings:
      system-upgrade-controller:
        type: ClusterRoleBinding
        roleRef:
          kind: ClusterRole
          name: cluster-admin
        subjects:
          - identifier: system-upgrade-controller

  serviceAccount:
    system-upgrade-controller: {}
